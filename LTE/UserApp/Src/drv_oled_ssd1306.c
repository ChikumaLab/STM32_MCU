/*
 * drv_oled_ssd1306.c
 *
 *  Created on: 2022/08/01
 *      Author: User
 */


#include "drv_oled_ssd1306.h"

uint8_t oled_init_cmd[] = {0x00,0x8D,0x14,0xAF};
uint8_t oled_cler_cmd[] = {0x00,0x20,0x00,0x21,0x00,0x7F,0x22,0x00,0x07};
uint8_t oled_disp[1024 + 1];
uint8_t oled_line_data[8] = {0x01, 0x02, 0x04, 0x08, 0x10, 0x20, 0x40, 0x80};
uint8_t antData[] = {0x01,0x03,0xFF,0x03,0x01,0xC0,0x00,0xF0,0x00,0xFF};

uint8_t oled_h_pos_cmd[] = {0x00,0x20,0x02,0x00,0x00,0x00};
uint8_t oled_sig_cmd[2][6] =
{
    {0xFF, 0xFF, 0xFF, 0xFF, 0x00, 0x00},
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x00}
};

I2C_HandleTypeDef *i2c_oled_ssd1306_if;


void drv_oled_ssd1306_init(I2C_HandleTypeDef *i2c)
{
	i2c_oled_ssd1306_if = i2c;

	HAL_I2C_Master_Transmit(i2c_oled_ssd1306_if, AE_SSD1306_I2C_ADDR, oled_init_cmd, (uint16_t)sizeof(oled_init_cmd),10);
}

void drv_oled_ssd1306_clear(void)
{
	int i;

	HAL_I2C_Master_Transmit(i2c_oled_ssd1306_if, AE_SSD1306_I2C_ADDR, oled_cler_cmd, sizeof(oled_cler_cmd),1000);
	oled_disp[0] = 0x40;
	for(i = 0;i < 1024;i++)
	{
		oled_disp[i +1] = 0x00;
	}
	HAL_I2C_Master_Transmit(i2c_oled_ssd1306_if, AE_SSD1306_I2C_ADDR, oled_disp, sizeof(oled_disp),1000);
}

void drv_oled_ssd1306_font_posi(uint8_t page, uint8_t column)
{
    char low_col;
    char hi_col;

    page = page + 0xB0;        // ﾍﾟｰｼﾞ情報をｺﾏﾝﾄﾞにする為に 0xB0 を加算
    low_col = column & 0x0F;
    column = column >> 4;
    hi_col = column + 0x10;
    oled_h_pos_cmd[3] = page;
    oled_h_pos_cmd[4] = low_col;
    oled_h_pos_cmd[5] = hi_col;

    HAL_I2C_Master_Transmit(i2c_oled_ssd1306_if, AE_SSD1306_I2C_ADDR, oled_h_pos_cmd, sizeof(oled_h_pos_cmd),100);
}

void drv_oled_ssd1306_set_char(uint8_t c)        // 6x8dotフォントの1文字表示関数
{
    uint8_t i;
    uint8_t txChar[7];

    c = c - 0x20;

    txChar[0] = 0x40;
    for(i=0; i<6; i++)
    {
        txChar[i + 1] = font6[c][i];
    }
	HAL_I2C_Master_Transmit(i2c_oled_ssd1306_if, AE_SSD1306_I2C_ADDR, txChar, sizeof(txChar),1000);
}

void drv_oled_ssd1306_set_h_line(uint8_t x,uint8_t y,uint8_t len)
{
	uint8_t i;
    uint8_t txData[130];
    uint8_t page = (y >> 4 ) ;
    uint8_t writeData = 0x01 << (y % 8);

    drv_oled_ssd1306_font_posi(page,x);

    txData[0] = 0x40;
    for(i = 0; i< len;i++)
    {
    	txData[i +1] =writeData;
    }
	HAL_I2C_Master_Transmit(i2c_oled_ssd1306_if, AE_SSD1306_I2C_ADDR, txData, len + 1,10);

}

void drv_oled_ssd1306_set_string(uint8_t x,uint8_t y,uint8_t *data,uint8_t len)
{
	uint8_t i;

	for(i = 0;i < len;i++)
	{
		drv_oled_ssd1306_font_posi(y, x + (i * 6));
		drv_oled_ssd1306_set_char(data[i]);
	}
}
void drv_oled_ssd1306_set_ant_param(uint8_t data)
{
    uint8_t txData[sizeof(antData) + 1];
    int i;
    drv_oled_ssd1306_font_posi(0, 0);
    txData[0] = 0x40;
    for(i = 0; i< sizeof(antData);i++)
    {
    	txData[i +1] =antData[i];
    }
    if(data < 3)
    {
    	txData[10] = 0x00;
    }
    if(data < 2)
    {
    	txData[8] = 0x00;
    }
    if(data < 1)
    {
    	txData[6] = 0x00;
    }
	HAL_I2C_Master_Transmit(i2c_oled_ssd1306_if, AE_SSD1306_I2C_ADDR, txData, sizeof(antData) + 1,1000);
}
void drv_oled_ssd1306_set_time(void)
{
	char string[32];
	uint8_t len ;
	RTC_TimeTypeDef sTime;
	RTC_DateTypeDef sDate;

	HAL_RTC_GetTime(&hrtc, &sTime, RTC_FORMAT_BIN);
	HAL_RTC_GetDate(&hrtc, &sDate, RTC_FORMAT_BIN);


//	sprintf(string,"20%02d %02d/%02d %02d%:%02d:%02d",sDate.Year,sDate.Month,sDate.Date,sTime.Hours,sTime.Minutes,sTime.Seconds);
	sprintf(string,"%02d:%02d:%02d",sTime.Hours,sTime.Minutes,sTime.Seconds);
	len = strlen(string);
	drv_oled_ssd1306_set_string(20,0,(uint8_t*)string,len);
}
void drv_oled_ssd1306_set_temp_param(float data)
{
	char string[32];
	uint8_t len ;

	sprintf(string,"%0.2fdeg",data);
	len = strlen(string);
	drv_oled_ssd1306_set_string(30,2,(uint8_t*)string,len);
}

void drv_oled_ssd1306_set_humdity_param(float data)
{
	char string[32];
	uint8_t len ;

	sprintf(string,"%0.2f%%",data);
	len = strlen(string);
	drv_oled_ssd1306_set_string(30,4,(uint8_t*)string,len);
}

void drv_oled_ssd1306_set_presser_param(float data)
{
	char string[32];
	uint8_t len ;

	sprintf(string,"%0.2fhPa",data);
	len = strlen(string);
	drv_oled_ssd1306_set_string(30,6,(uint8_t*)string,len);
}


void drv_oled_ssd1306_set_batt_param(uint8_t data)
{
    uint8_t txData[17];
    int i;

    uint8_t buf = data / 10 ;

    for(i = 2;i < 15;i++)
    {
        txData[i] = 0x81;
    }
    for(i = 0;i < buf;i++)
    {
        txData[i+3] = 0xBD;
    }

    drv_oled_ssd1306_font_posi(0, 100);
    txData[0] = 0x40;
    txData[1] = 0xFF;
    txData[15] = 0xE7;
    txData[16] = 0x3C;

	HAL_I2C_Master_Transmit(i2c_oled_ssd1306_if, AE_SSD1306_I2C_ADDR, txData, sizeof(txData) ,1000);

}

void drv_oled_ssd1306_set_lte_qual(uint8_t rssi,uint8_t rsrp,uint8_t rsrq, uint8_t sinr)
{
	char string[32];
	uint8_t len ;

	sprintf(string,"RSSI(%d),RSRP(%d)",rssi,rsrp);
	len = strlen(string);
	drv_oled_ssd1306_set_string(0,1,(uint8_t*)string,len);

	sprintf(string,"RSRQ(%d),SINR(%d)",rsrq,sinr);
	len = strlen(string);
	drv_oled_ssd1306_set_string(0,2,(uint8_t*)string,len);
}

void drv_oled_ssd1306_set_lte_cellData(uint8_t tac,uint8_t cell)
{
	char string[32];
	uint8_t len ;

	sprintf(string,"TAC(%d),CELL(%d)",tac,cell);
	len = strlen(string);
	drv_oled_ssd1306_set_string(0,3,(uint8_t*)string,len);
}

void drv_oled_ssd1306_set_lte_band(uint8_t band,uint8_t bandwide,uint8_t ulink)
{
	char string[32];
	uint8_t len ;

	sprintf(string,"BAND(%d),Wide(%d)",band,bandwide);
	len = strlen(string);
	drv_oled_ssd1306_set_string(0,4,(uint8_t*)string,len);
	sprintf(string,"U-link(%d)",ulink);
	len = strlen(string);
	drv_oled_ssd1306_set_string(0,5,(uint8_t*)string,len);
}

const char font6[91][6] =
{
    { 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 }, // " " 0x20
    { 0x00, 0x00, 0x4f, 0x00, 0x00, 0x00 }, // ! 0x21
    { 0x00, 0x07, 0x00, 0x07, 0x00, 0x00 }, // " 0x22
    { 0x14, 0x7f, 0x14, 0x7f, 0x14, 0x00 }, // # 0x23
    { 0x24, 0x2a, 0x7f, 0x2a, 0x12, 0x00 }, // $ 0x24
    { 0x23, 0x13, 0x08, 0x64, 0x62, 0x00 }, // % 0x25
    { 0x36, 0x49, 0x55, 0x22, 0x50, 0x00 }, // & 0x26
    { 0x00, 0x05, 0x03, 0x00, 0x00, 0x00 }, // ' 0x27
    { 0x00, 0x1c, 0x22, 0x41, 0x00, 0x00 }, // ( 0x28
    { 0x00, 0x41, 0x22, 0x1c, 0x00, 0x00 }, // ) 0x29
    { 0x14, 0x08, 0x3e, 0x08, 0x14, 0x00 }, // * 0x2A
    { 0x08, 0x08, 0x3e, 0x08, 0x08, 0x00 }, // + 0x2B
    { 0x00, 0x50, 0x30, 0x00, 0x00, 0x00 }, // , 0x2C
    { 0x08, 0x08, 0x08, 0x08, 0x08, 0x00 }, // - 0x2D
    { 0x00, 0x60, 0x60, 0x00, 0x00, 0x00 }, // . 0x2E
    { 0x20, 0x10, 0x08, 0x04, 0x02, 0x00 }, // / 0x2F
    { 0x3e, 0x51, 0x49, 0x45, 0x3e, 0x00 }, // 0 0x30
    { 0x00, 0x42, 0x7f, 0x40, 0x00, 0x00 }, // 1 0x31
    { 0x42, 0x61, 0x51, 0x49, 0x46, 0x00 }, // 2 0x32
    { 0x21, 0x41, 0x45, 0x4b, 0x31, 0x00 }, // 3 0x33
    { 0x18, 0x14, 0x12, 0x7f, 0x10, 0x00 }, // 4 0x34
    { 0x27, 0x45, 0x45, 0x45, 0x39, 0x00 }, // 5 0x35
    { 0x3c, 0x4a, 0x49, 0x49, 0x30, 0x00 }, // 6 0x36
    { 0x01, 0x71, 0x09, 0x05, 0x03, 0x00 }, // 7 0x37
    { 0x36, 0x49, 0x49, 0x49, 0x36, 0x00 }, // 8 0x38
    { 0x06, 0x49, 0x49, 0x29, 0x1e, 0x00 }, // 9 0x39
    { 0x00, 0x36, 0x36, 0x00, 0x00, 0x00 }, // : 0x3A
    { 0x00, 0x56, 0x36, 0x00, 0x00, 0x00 }, // ; 0x3B
    { 0x08, 0x14, 0x22, 0x41, 0x00, 0x00 }, // < 0x3C
    { 0x14, 0x14, 0x14, 0x14, 0x14, 0x00 }, // = 0x3D
    { 0x00, 0x41, 0x22, 0x14, 0x08, 0x00 }, // > 0x3E
    { 0x02, 0x01, 0x51, 0x09, 0x06, 0x00 }, // ? 0x3F
    { 0x32, 0x49, 0x79, 0x41, 0x3e, 0x00 }, // @ 0x40
    { 0x7e, 0x11, 0x11, 0x11, 0x7e, 0x00 }, // A 0x41
    { 0x7f, 0x49, 0x49, 0x49, 0x36, 0x00 }, // B 0x42
    { 0x3e, 0x41, 0x41, 0x41, 0x22, 0x00 }, // C 0x43
    { 0x7f, 0x41, 0x41, 0x22, 0x1c, 0x00 }, // D 0x44
    { 0x7f, 0x49, 0x49, 0x49, 0x41, 0x00 }, // E 0x45
    { 0x7f, 0x09, 0x09, 0x09, 0x01, 0x00 }, // F 0x46
    { 0x3e, 0x41, 0x49, 0x49, 0x7a, 0x00 }, // G 0x47
    { 0x7f, 0x08, 0x08, 0x08, 0x7f, 0x00 }, // H 0x48
    { 0x00, 0x41, 0x7f, 0x41, 0x00, 0x00 }, // I 0x49
    { 0x20, 0x40, 0x41, 0x3f, 0x01, 0x00 }, // J 0x4A
    { 0x7f, 0x08, 0x14, 0x22, 0x41, 0x00 }, // K 0x4B
    { 0x7f, 0x40, 0x40, 0x40, 0x40, 0x00 }, // L 0x4C
    { 0x7f, 0x02, 0x0c, 0x02, 0x7f, 0x00 }, // M 0x4D
    { 0x7f, 0x04, 0x08, 0x10, 0x7f, 0x00 }, // N 0x4E
    { 0x3e, 0x41, 0x41, 0x41, 0x3e, 0x00 }, // O 0x4F
    { 0x7f, 0x09, 0x09, 0x09, 0x06, 0x00 }, // P 0x50
    { 0x3e, 0x41, 0x51, 0x21, 0x5e, 0x00 }, // Q 0x51
    { 0x7f, 0x09, 0x19, 0x29, 0x46, 0x00 }, // R 0x52
    { 0x46, 0x49, 0x49, 0x49, 0x31, 0x00 }, // S 0x53
    { 0x01, 0x01, 0x7f, 0x01, 0x01, 0x00 }, // T 0x54
    { 0x3f, 0x40, 0x40, 0x40, 0x3f, 0x00 }, // U 0x55
    { 0x1f, 0x20, 0x40, 0x20, 0x1f, 0x00 }, // V 0x56
    { 0x3f, 0x40, 0x38, 0x40, 0x3f, 0x00 }, // W 0x57
    { 0x63, 0x14, 0x08, 0x14, 0x63, 0x00 }, // X 0x58
    { 0x07, 0x08, 0x70, 0x08, 0x07, 0x00 }, // Y 0x59
    { 0x61, 0x51, 0x49, 0x45, 0x43, 0x00 }, // Z 0x5A
    { 0x00, 0x7f, 0x41, 0x41, 0x00, 0x00 }, // [ 0x5B
    { 0x02, 0x04, 0x08, 0x10, 0x20, 0x00 }, // "\" 0x5C
    { 0x00, 0x41, 0x41, 0x7f, 0x00, 0x00 }, // ] 0x5D
    { 0x04, 0x02, 0x01, 0x02, 0x04, 0x00 }, // ^ 0x5E
    { 0x40, 0x40, 0x40, 0x40, 0x40, 0x00 }, // _ 0x5F
    { 0x00, 0x01, 0x02, 0x04, 0x00, 0x00 }, // ` 0x60
    { 0x20, 0x54, 0x54, 0x54, 0x78, 0x00 }, // a 0x61
    { 0x7f, 0x48, 0x44, 0x44, 0x38, 0x00 }, // b 0x62
    { 0x38, 0x44, 0x44, 0x44, 0x20, 0x00 }, // c 0x63
    { 0x38, 0x44, 0x44, 0x48, 0x7f, 0x00 }, // d 0x64
    { 0x38, 0x54, 0x54, 0x54, 0x18, 0x00 }, // e 0x65
    { 0x08, 0x7e, 0x09, 0x01, 0x02, 0x00 }, // f 0x66
    { 0x0c, 0x52, 0x52, 0x52, 0x3e, 0x00 }, // g 0x67
    { 0x7f, 0x08, 0x04, 0x04, 0x78, 0x00 }, // h 0x68
    { 0x00, 0x44, 0x7d, 0x40, 0x00, 0x00 }, // i 0x69
    { 0x20, 0x40, 0x44, 0x3d, 0x00, 0x00 }, // j 0x6A
    { 0x7f, 0x10, 0x28, 0x44, 0x00, 0x00 }, // k 0x6B
    { 0x00, 0x41, 0x7f, 0x40, 0x00, 0x00 }, // l 0x6C
    { 0x7c, 0x04, 0x18, 0x04, 0x78, 0x00 }, // m 0x6D
    { 0x7c, 0x08, 0x04, 0x04, 0x78, 0x00 }, // n 0x6E
    { 0x38, 0x44, 0x44, 0x44, 0x38, 0x00 }, // o 0x6F
    { 0x7c, 0x14, 0x14, 0x14, 0x08, 0x00 }, // p 0x70
    { 0x08, 0x14, 0x14, 0x18, 0x7c, 0x00 }, // q 0x71
    { 0x7c, 0x08, 0x04, 0x04, 0x08, 0x00 }, // r 0x72
    { 0x48, 0x54, 0x54, 0x54, 0x20, 0x00 }, // s 0x73
    { 0x04, 0x3f, 0x44, 0x40, 0x20, 0x00 }, // t 0x74
    { 0x3c, 0x40, 0x40, 0x20, 0x7c, 0x00 }, // u 0x75
    { 0x1c, 0x20, 0x40, 0x20, 0x1c, 0x00 }, // v 0X76
    { 0x3c, 0x40, 0x30, 0x40, 0x3c, 0x00 }, // w 0x77
    { 0x44, 0x28, 0x10, 0x28, 0x44, 0x00 }, // x 0x78
    { 0x0c, 0x50, 0x50, 0x50, 0x3c, 0x00 }, // y 0x79
    { 0x44, 0x64, 0x54, 0x4c, 0x44, 0x00 } // z 0x7A
}; // 6x8dot
